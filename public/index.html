<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/tailwindcss/dist/tailwind.min.css" rel="stylesheet">
        <link rel="stylesheet" href="styles.css">
        <title>Elm Chat</title>
    </head>
    <body>
        <div id="elm-root"></div>

        <script src="https://www.gstatic.com/firebasejs/5.11.1/firebase.js"></script>
        <script src="elm.js"></script>
        <script>
            const el = document.getElementById('elm-root');
            const app = Elm.Main.init({
                node: el
            });

            firebase.initializeApp({
                apiKey: "AIzaSyBv3uq1UCOKbQV7YT_9rITuXQVngVzTBLM",
                projectId: "elm-chat-app",
                databaseURL: "elm-chat-app.firebaseio.com"
            });

            const db = firebase.firestore();

            app.ports.storeUser.subscribe(data => {
                db.collection('users').doc(data.id).set({
                    name: data.name
                });
            });

            app.ports.chatPageLoaded.subscribe(chatInit => {
                db.collection('users').where('name', '==', chatInit.chatName).limit(1).get()
                    .then(snapshot => {
                        let chatId = null;

                        snapshot.forEach(doc => {
                            chatId = doc.id;
                        })
                        
                        app.ports.getUserId.send(chatId);
                    })
                    .catch(error => console.error(error));

                fetchRoom(chatInit.roomName);
            });

            app.ports.storeMessage.subscribe(message => {
                let msgData = {
                    body: message.body,
                    userId: message.userId,
                    roomId: message.roomId
                };

                db.collection('messages').doc(message.id).set(msgData);


                db.collection('messages').doc(message.id).onSnapshot(doc => {
                    getChatName({ id: doc.id, chatName: "Unknown", ...doc.data() });
                })
            });

            function fetchRoom(room) {
                db.collection('rooms').where('name', '==', room).limit(1).get()
                    .then(roomSnapshot => {
                        let roomId = null;

                        roomSnapshot.forEach(doc => {
                            roomId = doc.id;
                        });

                        fetchMessages(roomId);
                    })
                    .catch(error => {
                        console.error(error);
                    });
            }

            function fetchMessages(roomId) {
                db.collection('messages').where('roomId', '==', roomId).get()
                    .then(snapshot => {
                        snapshot.forEach(doc => {
                            const msgData = {
                                id : doc.id,
                                userId : doc.data().userId,
                                body: doc.data().body,
                                roomId: roomId,
                                chatName: "Unknown" // Elm is expecting a value here so give it a default just in case something goes terribly wrong
                            };

                            getChatName(msgData);
                        });
                    })
                    .catch(() => {
                        // Elm is expecting a list of objects so it's a-okay to send an empty list here
                        app.ports.getMessage.send([]);
                    });
            }

            function getChatName(msgData) {
                // We need to get the correct user name for each message
                db.collection('users').doc(msgData.userId).get()
                    .then(snapshot => {
                        msgData.chatName = snapshot.data().name;
                        app.ports.getMessage.send(msgData);
                    })
                    .catch(error => {
                        app.ports.getMessage.send(msgData);
                        console.error(error);
                    });
            }
        </script>
    </body>
</html>